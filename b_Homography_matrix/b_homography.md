# Overview
- 개념이 너무 어려워 다시 다른 사이트를 통해 정리를 해보려한다.
- ground projection을 예시로한 블로거가 있어서 이를 토대로 정리한다.
- 카메라 영상에서 사람이나 자동차를 찾았을 때 찾은 물체가 카메라로부터 실제로 얼마나 멀리 떨어져있는지 알아내는 것은 영상기하학의 가장 빈번한 응용중 하나다.
  - 카메라에 잡힌 물체의 실제거리, 크기, 남은거리, 이동속도 등

![image](https://user-images.githubusercontent.com/69780812/146337378-98e7ff93-cb43-4a90-9f23-75669a49c3d9.png)
- 위와 같이 영상에서 자동차와 보행자를 찾았다고하자.
- 알고자 하는 것 : 물체가 카메라로부터 실제 얼마나 떨어져있고 크기(폭, 높이)는 얼마인가
  - 2D 좌표임에 주의해야한다.
- 불변의 가정 : **물체는 ground에 붙어있다.**
- 물체의 위치(지면 좌표)가 구해지면 물체의 크기(폭, 높이)는 간단한 비례식으로 손쉽게 계산될 수 있다.
- 문제의 가정
  - 1. 카메라의 높이와 방향이 고정
  - 2. 물체는 항상 지면에 붙어있다.
  - 3. 카메라 파라미터를 알고있다. (렌즈 왜곡 계수, 높이, 각도 등)
- 이를 통해 풀고자하는 것은 임의의 영상좌표에 대응되는 2D 지면 좌표를 구하는 것이다.

# 1. 직접적 기하학적 계산 방법
![image](https://user-images.githubusercontent.com/69780812/146631800-91f87e4a-7871-4094-b90e-7a784ca832c5.png)
- 영상 좌표 p에 대응되는 지면 좌표를 P라하자.
- 카메라 원점 p와 P는 그림과 같이 일직선 상에 존재한다.
- 카메라 내부파라미터, 지면 높이, 카메라 틸트는 알고 있다고 가정
- 입력 영상 픽셀좌표 p(x,y), 대응되는 지면좌표를 P(X, Y)라 하자.

![image](https://user-images.githubusercontent.com/69780812/146631832-19aca6e2-68c1-4c66-983b-b6f5cb133107.png)
- 먼저 카메라의 내부파라미터 영향을 없애기 위해 픽셀좌표를 정규좌표로 변환한다.

![image](https://user-images.githubusercontent.com/69780812/146632059-f608fbd0-0910-4484-a2b6-000bcaccf89d.png)
- 정규좌표 (u, v)와 카메라 높이 h, 틸트 tilit angle을 이용한 이후의 계산과정은 위와 같다.

![image](https://user-images.githubusercontent.com/69780812/146632096-2ea32517-36ee-49fc-8584-57184d911aa3.png)
- top-view로 계산결과에 대해 보자.
- 계산결과에서 d는 카메라 원점과 물체와의 지면에서의 거리이다.
- theta는 카메라 광학축을 기준으로한 물체의 방향각이다.
  - 카메라 광학축 기준 왼쪽 +, 오른쪽 -

![image](https://user-images.githubusercontent.com/69780812/146632122-e1e8326a-e9af-4248-ad07-41b3bf8e7812.png)
- 물체의 위치를 지면좌표로 표현하면 위와 같다.
- 카메라 위치를 지면 좌표계의 원점, 광학축 방향을 X축으로 가정했을 때 좌표이다.
- 위에서 설명한 기하학적 방법은 카메라의 Roll이 0인 경우에만 성립한다.
  - 카메라의 roll이 0이아닌 경우는 아래에서 설명한다.
- 최종 계산된 P(X,Y)는 **지면 좌표계를 어떻게 정의하느냐에 따라** 달라질 수 있는 값이다. 
  - 여기서는 카메라 원점을 지면에 수직으로 투영시킨 점을 원점, 카메라 광학축 방향을 X축으로 잡았을 경우의 좌표다.

# 2. Homography를 사용한 방법
- 실용적으로 가장 간편한 방법이다.
- 특별한 이론적 지식 없이 사용 가능하다.
- 몇몇 샘플링 된 영상좌표들에 대해 대응되는 지면좌표를 실측을 통해 구한 후 여기서 얻어진 영상좌표를 지면좌표 변환관계를 다른 경우에도 일반화해서 적용하는 것이다.

![image](https://user-images.githubusercontent.com/69780812/146632294-9b43b386-c67b-4114-b2aa-daa05d1496cf.png)
- Homography : 한 평면을 다른 평면에 Projection 시켰을 때 투영된 대응점들 사이에는 일정한 변환관계가 성립하는데 이 변환 관계를 호모피그래피라고 부른다.
- Homography는 3x3 행렬로 표현되며 대응점들의 homogeneous coordinate 표현에 대해 성립하는 변환관계다.

![image](https://user-images.githubusercontent.com/69780812/146632327-4bc81e3a-a277-4d81-9b09-0c92e855a312.png)
- 한 평면 위의 점들 (x1, y1), (x2, y2), ...이 다른 평면 위 점들 (x1', y1'), (x2', y2'), ...로 각각 투영되었다면 이 대응점들 사이에는 **3x3 호모그래피 행렬 H가 항상 존재하고 유일하게 존재**한다.
  - scale factor 무시의 경우
- s : homogeneous coordinate 표현에서 scale factor이다.
- 여기서 H가 유일하게 존재한다는 점에 주목할 필요가 있다.
  - p1, p2, p3, p4를 이용해서 H를 구하거나 p2, p3, p4, p5를 이용해서 H를 구하나 그 결과가 동일하다는 뜻이다.
  - **일반적으로 4개의 대응쌍**이 필요하다.
- **임의의 네 대응상을 이용해 구한 H를 다른 모든 점들에 대해 동일하게 적용할 수 있다.**

![image](https://user-images.githubusercontent.com/69780812/146632408-e807a6dd-f488-4c35-b616-a4d192bec4d1.png)
- 두 이미지에서 4개의 대응쌍을 찾아서 대응 좌표들로 부터 H를 구했다고 해보자.
- p5에 대응되는 점의 이미지 B에서의 좌표는 H*p5로 구할 수 있다.
  - 마우스 패드상 다른 모든 대응점에 대해서도 p' = Hp가 성립한다.

![image](https://user-images.githubusercontent.com/69780812/146632483-d3e59354-9a52-4d70-b05d-9994eaa61afb.png)
- Homography는 투영 관게에 있는 두 평면 사이의 변환관계라고 했다. 하지만 위에서는 서로 다른 두 이미지에 투영된 마우스 패드 좌표들 사이 대응관계에 호모그래피를 사용했다.
- Homography는 직접적인 투영관계에 있는 두 평면 사이에서뿐 아니라 투영관계에 의해 직간접적으로 연결되는 모든 평면들 사이에서도 일반적으로 성립한다.
  - 즉, 한 평면을 평면 A와 평면 B에 각각 투영하면 평면 A에 투영된 좌표와 평면 B에 투영된 좌표 사이에도 호모그래피가 성립한다.
  - 그 이유는 원래 평면 좌표를 p, 평면 A에 투영된 좌표를 p', 평면 B에 투영된 좌표를 p'', 원래 평면과 평면 A와의 호모그래피를 H1, 평면 B와 호모그래피를 H2라 하면 p'=H1p, p''=H2p=H2(H1^-1p')=H2H1^-1p'이 성립한다.
- 호모그래피를 사용하는데 있어서 한가지 주의할 사항은 **평면형 물체에 대해서만 성립한다는 점이다.**
  - 입체를 가진 물체에 대해서는 호모그래피가 성립하지 않는다.
  - 풀고자 하는 문제의 경우 지면과 이미지 평면과의 관계이므로 호모그래피가 성립한다.
- 영상에서 검출된 물체의 실제 위치를 구하는 방법을 알아보자.
  - 먼저, 카메라 시야 내 바닥에 임의의 네점을 잡고 이들의 지면 좌표를 실측을 통해 측정한다.
  - 지면 좌표계의 기준(원점 등)은 자신이 원하는 데로 잡는다.
  - CCTV의 경우 건물 내 고정된 카메라이므로 벽의 한쪽 모서리 등을 원점으로 잡는게 실측에 편하다.
  - 자동차에 부착된 카메라라면 자동차의 앞마퀴 중심이나 카메라를 원점으로 잡는게 편하다.
  - 아무튼 자신이 잡은 기준에 맞춰 네 점의 지면좌표 측정 후 해당 점들의 영상좌표 (픽셀좌표)를 구한다.
- 픽셀 좌표로 부터 지면 좌표로의 호모그래피 변환행렬 H 계산은 opencv의 findHomography 함수를 이용하거나 직접 구현한다.
- 호모 그래피 행렬이 구해졌다면, 임의의 영상 픽셀 좌표 p(x, y)에 대응되는 지면좌표 p는 동차좌표로 확장한 (x, y, 1)에 H를 곱한 결과를 다시 2D 좌표로 변환하여 얻어진다.
  - H*(x, y, 1)T = (a, b, c)T라면 구하고자 하는 지면 좌표는 (a/c, b/c)가 된다.
  - 호모그래피는 영상 픽셀좌표에 직접 적용해도 좋지만 영상의 왜곡까지 고려한다면 픽셀 좌표를 정규이미지좌표로 변환 후 정규 이미지 좌표에 대해 호모그래피를 계산 및 적용하는 것이 효과적이다.
