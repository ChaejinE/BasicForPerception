# Overview
- 카메라 외부 파라미터 (extrinsic params)인 3차원 위치 및 자세(pan, tilt, roll, yaw)를 파악하는 방법을 정리한다.
- 크기 및 형태를 미리 알고 있는 외부 물체에 대한 영상을 분석해 **영상을 획득할 당시의 카메라 3차원 위치(지면으로부터의 높이 등) 및 3D 자세 정보(pan, tilt or pitch, roll, yaw)를 추출**하는 것이 목적이다.

# 2D 공간좌표와 2D 영상 좌표
- 2D 영상을 3차원으로 해석하는 것이 핵심이다.

![image](https://user-images.githubusercontent.com/69780812/146494545-e47903c3-ac52-4349-86e0-34f7021b649c.png)
- 월드 좌표계는 무시하고 카메라를 중심으로 3차원 좌표계(광학축:Z, 오른쪽:X, 아래쪽: Y)를 설정했을 때, 외부 한점 P(X, Y, Z)에 대한 영상좌표를 구하는 문제를 생각해보자.
- P(X, Y, Z)는 카메라로부터 수직방향으로 Z만큼 떨어진 거리에 있는 점이므로 카메라로부터 거리가 1인 가상의 정규 이미지 평면에서 좌표는 삼각형 닮음비로 P'(X/Z, Y,/Z, 1)이 됨을 알 수 있다. 하지만 실제 카메라 영상은 초점 거리 f 만큼 떨어진 이미지 평면에 Projection 되므로 P에 대응되는 이미지 좌표는 P''(fx\*X/Z, fy\*Y/Z)로 계산한다.
  - 이를 픽셀 좌표계, 이미지 좌상단이 원점인 좌표계로 맞추기 위해 영상 중심을 cx, cy로하여 최종 영상 좌표를 계산하면 된다.
  - x = fx\*(X/Z) + cx, y = fy\*(Y/Z) + cy가 최종 영상 좌표가 된다.
  - 역으로 2D p(x, y)에 대응하는 3D 공간 좌표는 먼저 (x-cx, y-cy)로 영상 좌표 원점을 영상 중심으로 옮긴 후 Z거리가 1인 정규 이미지 평면에서 변환해주면 된다. 그리고 실제 물체아의 거리 Z를 반영해주면 된다.
  - X = (x-cx)/fx\*Z, Y = (y-cy)/fy\*Z (Z를 모르면 3차원 좌표는 유일하게 결정되지 않는다.)
- 단순할 수 있으나 실제 카메라 영상에서 그대로 성립하는 고나계다.
  - 렌즈계 왜곡 모델이 반영되어야 정확하겠지만 심하지 안하면 위 변환 모델을 그대로 사용해도 무방하다.

# 카메라의 3D 위치 및 자세 파악
- 전제 조건이 필요하다.
  - 1. 해당 카메라 내부 파라미터 (instrinsic parameters) 및 왜곡 계수를 알고 있어야한다.
    - fx, fy, cx, cy, k1, k2, p1, p2
  - 2. 물체에 대한 최소 4개 이상의 3D 월드 좌표와 이에 대응 되는 2D 영상좌표 쌍이 필요하다.

![image](https://user-images.githubusercontent.com/69780812/146495377-d97c03dc-aee2-4aa0-b8d1-ea69349116e6.png)
- 한 변의 길이가 1인 사각형 마크를 바닥에 놓고 카메라로 영상을 획득했다고 해보자.
- 사각형 꼭지점들에 대한 영상좌표를 구한 후 사각형 꼭지점들의 3D 월드 좌표와 2D 영상 좌표 쌍들을 opencv의 solvePnP()함수에 넣어주면 카메라의 위치 및 자세정보가 나온다.
  - solvePnP 함수가 반환하는 rvec은 회전 변환에 대한 Rodrigues 표현이므로 회전 변환 행렬 R은 Rodrigues() 함수를 통해 추출해야한다.

![image](https://user-images.githubusercontent.com/69780812/146497909-aae4c6d0-e4db-4169-aadc-d4ce101554fc.png)
- 3차원 공간상 한점 P에 대한 월드 좌표를 Pw = [xw, yw, zw]^T, 카메라 좌표계에서 봤을 때 좌표를 Pc = [xc, yc, zc]^T
- solvePnP 함수가 반환하는 회전 변환 행렬을 R, 평행이동 벡터를 T라고 했을 때 위와 같은 변환 관계식이 성립한다.

![image](https://user-images.githubusercontent.com/69780812/146497955-fc68d074-77ca-4e14-a01d-6570f33eb60c.png)
- 카메라 3D 위치(월드 좌표계)는 카메라 좌표계의 원점에 대응하는 월드 좌표이므로 위와 같이 계산된다.

![image](https://user-images.githubusercontent.com/69780812/146498041-266b7f28-37d4-4826-8f4e-4a0a39d55abb.png)
- 자세 정보를 구하는 데 있어서 평행이동은 관계없는 요소이므로 회전 변환만을 고려해서 카메라 광학축 벡터 Zc=[0,0,1]^T에 대한 월드 좌표 Zw를 위와 같이 계산한다.

![image](https://user-images.githubusercontent.com/69780812/146498180-b0b0df2e-3589-4b05-a933-f07b0ae79de8.png)
- 계산된 강학축에 대한 월드좌표가 계산되면 카메라의 pan, tilt는 위와 같이 계산된다.