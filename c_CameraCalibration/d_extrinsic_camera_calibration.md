# Overview
- 카메라 외부 파라미터 (extrinsic params)인 3차원 위치 및 자세(pan, tilt, roll, yaw)를 파악하는 방법을 정리한다.
- 크기 및 형태를 미리 알고 있는 외부 물체에 대한 영상을 분석해 **영상을 획득할 당시의 카메라 3차원 위치(지면으로부터의 높이 등) 및 3D 자세 정보(pan, tilt or pitch, roll, yaw)를 추출**하는 것이 목적이다.

# 2D 공간좌표와 2D 영상 좌표
- 2D 영상을 3차원으로 해석하는 것이 핵심이다.

![image](https://user-images.githubusercontent.com/69780812/146494545-e47903c3-ac52-4349-86e0-34f7021b649c.png)
- 월드 좌표계는 무시하고 카메라를 중심으로 3차원 좌표계(광학축:Z, 오른쪽:X, 아래쪽: Y)를 설정했을 때, 외부 한점 P(X, Y, Z)에 대한 영상좌표를 구하는 문제를 생각해보자.
- P(X, Y, Z)는 카메라로부터 수직방향으로 Z만큼 떨어진 거리에 있는 점이므로 카메라로부터 거리가 1인 가상의 정규 이미지 평면에서 좌표는 삼각형 닮음비로 P'(X/Z, Y,/Z, 1)이 됨을 알 수 있다. 하지만 실제 카메라 영상은 초점 거리 f 만큼 떨어진 이미지 평면에 Projection 되므로 P에 대응되는 이미지 좌표는 P''(fx\*X/Z, fy\*Y/Z)로 계산한다.
  - 이를 픽셀 좌표계, 이미지 좌상단이 원점인 좌표계로 맞추기 위해 영상 중심을 cx, cy로하여 최종 영상 좌표를 계산하면 된다.
  - x = fx\*(X/Z) + cx, y = fy\*(Y/Z) + cy가 최종 영상 좌표가 된다.
  - 역으로 2D p(x, y)에 대응하는 3D 공간 좌표는 먼저 (x-cx, y-cy)로 영상 좌표 원점을 영상 중심으로 옮긴 후 Z거리가 1인 정규 이미지 평면에서 변환해주면 된다. 그리고 실제 물체아의 거리 Z를 반영해주면 된다.
  - X = (x-cx)/fx\*Z, Y = (y-cy)/fy\*Z (Z를 모르면 3차원 좌표는 유일하게 결정되지 않는다.)
- 단순할 수 있으나 실제 카메라 영상에서 그대로 성립하는 고나계다.
  - 렌즈계 왜곡 모델이 반영되어야 정확하겠지만 심하지 안하면 위 변환 모델을 그대로 사용해도 무방하다.

# 카메라의 3D 위치 및 자세 파악
- 전제 조건이 필요하다.
  - 1. 해당 카메라 내부 파라미터 (instrinsic parameters) 및 왜곡 계수를 알고 있어야한다.
    - fx, fy, cx, cy, k1, k2, p1, p2
  - 2. 물체에 대한 최소 4개 이상의 3D 월드 좌표와 이에 대응 되는 2D 영상좌표 쌍이 필요하다.

![image](https://user-images.githubusercontent.com/69780812/146495377-d97c03dc-aee2-4aa0-b8d1-ea69349116e6.png)
- 한 변의 길이가 1인 사각형 마크를 바닥에 놓고 카메라로 영상을 획득했다고 해보자.
- 사각형 꼭지점들에 대한 영상좌표를 구한 후 사각형 꼭지점들의 3D 월드 좌표와 2D 영상 좌표 쌍들을 opencv의 solvePnP()함수에 넣어주면 카메라의 위치 및 자세정보가 나온다.
  - solvePnP 함수가 반환하는 rvec은 회전 변환에 대한 Rodrigues 표현이므로 회전 변환 행렬 R은 Rodrigues() 함수를 통해 추출해야한다.

![image](https://user-images.githubusercontent.com/69780812/146497909-aae4c6d0-e4db-4169-aadc-d4ce101554fc.png)
- 3차원 공간상 한점 P에 대한 월드 좌표를 Pw = [xw, yw, zw]^T, 카메라 좌표계에서 봤을 때 좌표를 Pc = [xc, yc, zc]^T
- solvePnP 함수가 반환하는 회전 변환 행렬을 R, 평행이동 벡터를 T라고 했을 때 위와 같은 변환 관계식이 성립한다.

![image](https://user-images.githubusercontent.com/69780812/146497955-fc68d074-77ca-4e14-a01d-6570f33eb60c.png)
- 카메라 3D 위치(월드 좌표계)는 카메라 좌표계의 원점에 대응하는 월드 좌표이므로 위와 같이 계산된다.

![image](https://user-images.githubusercontent.com/69780812/146498041-266b7f28-37d4-4826-8f4e-4a0a39d55abb.png)
- 자세 정보를 구하는 데 있어서 평행이동은 관계없는 요소이므로 회전 변환만을 고려해서 카메라 광학축 벡터 Zc=[0,0,1]^T에 대한 월드 좌표 Zw를 위와 같이 계산한다.

![image](https://user-images.githubusercontent.com/69780812/146498180-b0b0df2e-3589-4b05-a933-f07b0ae79de8.png)
- 계산된 강학축에 대한 월드좌표가 계산되면 카메라의 pan, tilt는 위와 같이 계산된다.
- pitch, roll, yaw 관점에서 보면 tilt는 pitch, pan은 yaw에 해당한다.

![image](https://user-images.githubusercontent.com/69780812/146631708-9297abe7-1ad5-4daf-9806-bb7554e5d5b9.png)
- roll은 카메라 좌표계의 X축 벡터 Xc=[1,0,0]T에 대한 월드 좌표 벡터 Xw=[xx,xy,xz]T와 월드 좌표계의 X축을 Z축 중심으로 pan 각 만큼 회전시킨 Xpan 사이의 회전각으로 계산된다.
- roll은 카메라 광학축을 기존으로한 회전각도이다. 카메라와 같은 방향을 바라볼 때 반시계방향이 +이다.
- 단, sign() 함수는 부호함수다.
- 이와 같이 어떤 물체에 대한 월드좌표-영상좌표 대응쌍을 4개만 알면 카메라에 대한 모든 위치 및 3D 자세정보를 파악할 수 있다.

# 3. 3D 변환을 이용한 방법
- 카메라의 내부 파라미터 (fx, fy, cx, cy) 및 3D 자세 정보 (R, t)는 미리 주어져 있다고 가정해보자.
  - 내부 파라미터는 카메라 캘리브레이션을 통해 구할 수 있다.
  - 3D 자세 정보는 OpenCV의 solvePnP 함수를 이용해 구할 수 있다.

![image](https://user-images.githubusercontent.com/69780812/146632960-0f09c4dd-d91d-47f6-a647-a59ac22dfd73.png)
- 3차원 공간상의 한 점 P에 대한 카메라 좌표를 Pc, 월드좌표를 Pw라 하면 Pc, Pw 사이 변환은 위 수식에 의해 주어진다.
- 입력 영상 픽셀 좌표를 p(x, y) 대응되는 지면 좌표를 P(X, Y)라 하자.

![image](https://user-images.githubusercontent.com/69780812/146632990-bdd07724-bc23-40a0-9dc6-3029ecb87360.png)
- 카메라의 내부파라미터 영향을 없애기 위해 픽셀좌표를 정규 좌표로 변환한다.
  - 영상에서 모든 기하학적 해석은 정규좌표를 통해 이뤄진다.
- 이 때 구한 정규좌표를 3차원 좌표로 해석하면 (u, v, 1)이 된다.
- 정규 이미지 평면은 카메라 원점에서 초점 거리가 1인 평면이다. 그러므로 정규 이미지 평면 상의 점 (u, v)의 카메라좌표계 좌표는 (u, v, 1)이 된다. pc라고하자.
- 카메라 원점과 pc를 연결한 직선이 지면과 만나는 점을 구하면 원하는 답을 구할 수 있다.

![image](https://user-images.githubusercontent.com/69780812/146633067-96e1a56d-c028-4b95-88b5-5cb4ca904e25.png)
- 지면과의 교점을 구하기 위해서는 카메라 좌표계가 아닌 월드 좌표계에서 계산을 수행해야한다.
  - 카메라 원점의 카메라 좌표 Cc, 월드좌표를 Cw라하고, 점 pc의 월드 좌표를 pw라하자.
- 카메라 원점의 카메라 좌표는 항상 (0, 0, 0)임에 주의한다.
  - 즉, Cc = (0, 0, 0)이다.

![image](https://user-images.githubusercontent.com/69780812/146633131-e2e78c21-10d7-4c90-83c8-abbbf1efba0b.png)
- 대응되는 월드 좌표는 위의 식을 이용해 이전의 그림과 같이 구해진다.
- 월드 좌표계상에서 Cw, pw를 잇는 직선이 지면과 만나는 점을 구하면된다.

![image](https://user-images.githubusercontent.com/69780812/146633151-1756a297-e96f-4b95-9c23-7b85254e2858.png)
- vector 개념을 이용하면 Cw, pw를 잇는 직선상의 임의의 점은 P = Cw + k(pw-Cw)로 표현할 수 있다.
- 월드 좌표계상에서 지면은 Z = 0인 경우이므로 위의 우항의 Z 좌표가 0이되도록 k의값을 구한 후 대입하면 원하는 지면 좌표 P가 구해진다.
  - 월드좌표계를 어떻게 설정하느냐에 따라 달라지는 값이다.

# 세 방법 비교
- 어느 방법을 써도 무방하나 기하학적 계산법은 카메라가 옆으로 기울어진 경우인 roll=0이 아닌 경우에는 사용할 수 없다.
  - 호모그래피, 3D 변환 방법은 적용할 수 있다.
- 호모 그래피 방법은 카메라 캘리브레이션 없이도 픽셀 좌표만 가지고 곧바로 적용할 수 있는 장점이 있다.
  - 영상 왜곡도 고려하려면 카메라 캘리브레이션이 필요하다.
- 3D 변환 기법은 가장 일반적이면서 다른 문제에도 확장 적용할 수 있다는 장점이 있다.

# 물체 크기 구하기
![image](https://user-images.githubusercontent.com/69780812/146633204-dd783ff8-9068-4a8c-8805-f6809cf34146.png)
- 앞서 방법들을 이용해 물체의 위치(지면 좌표)가 구해지면 크기, 높이를 구하는 것은 비례식을 이용해 쉽게 계산할 수 있다.
- 카메라의 지면에서 높이를 h_cam, 물체의 키를 h_obj라 하자.
  - 카메라의 높이는 미리 알고 있다고 가정
- d1은 앞서 구한 방법을 통해 이미 구해진 상태다.
- 물체의 발끝이 아닌 머리 끝지점에 대한 지면 좌표를 앞서 방법으로 구한 지면 좌표는 카메라와 물체의 최상단 끝을 연결한 선이 지면과 만나는 점이다.
  - d2
- 삼각형 비례관계에 의해 h_cam:h_obj = d2 : d2 - d1이 성립하므로 계산이 된다.
  - h_obj = h_cam*(d2-d1)/d2