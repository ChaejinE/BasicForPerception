# Overview
- 실제 눈 : 3차원, 카메라 : 2차원
- 3차원 점들이 이미지 상에서 어디에 맺히는지는 기하학적으로 생각하면 영상을 찍을 당시의 카메라 위치 및 방향에 의해 결정된다.
  - 실제 이미지는 실제 사용 렌즈, 렌즈와 이미지 센서와의 거리, 렌즈와 이미지 센서가 이루는 각등 내부의 기구적 부분에서 크게 영향을 받는다.
- 내부적 요인들을 제거해야만 3차원 점들이 영상에 투영된 위치를 구하거나 역으로 구해낼 때, 정확한 계산이 가능해진다.
- 이러한 내부요인의 파라미터 값을 구하는 과정을 **카메라 캘리브레이션**이라고한다.

![image](https://user-images.githubusercontent.com/69780812/146338283-d30ef26c-7361-4e45-9200-ca51634bbd27.png)
- 카메라 영상은 3D 공간상의 점들을 2D 평면에 Projectio함으로써 얻어진다.
- pinhole 카메라 모델에서 이러한 변환 관계는 위와 같이 모델링 된다.
- X,Y,Z : world coordinate system 상 3d points
- \[R|t] : world 좌표계를 카메라 좌표계로 변환시키기 위한 회전/이동 변환 행렬
- A : instrinsic camera matrix

![image](https://user-images.githubusercontent.com/69780812/146338739-68256e83-8b56-44c7-a0d6-cb45514e4bf0.png)
- 수식적으로 봤을 때, Camera Calibration은 위아 같은 **3D 공간 좌표와 2D 영상 좌표 사이 변환관계 또는 이 변환관계를 설명하는 파라미터를 찾는 과정**이다.
- A, \[R|t]를 합쳐서 camera matrix or projection matrix라고 부른다.
- 카메라 외부 파라미터 : 카메라의 설치 높이, 방향(pan, tilt) 등 **카메라와 외부공간과의 기하학적 관계에 관련된 파라미터**
- 카메라 내부 파라미터 : 카메라의 초점 거리, aspect ratio, 중심점 등 카메라 자체의 내부 파라미터

# Instrinsic parameters
## 1. Focal length (초점 거리)
![image](https://user-images.githubusercontent.com/69780812/146339313-cbcf856a-b0e4-44ac-97a8-8dade22affce.png)
- 여기서 말하는 초점 : 렌즈 중심과 이미지 센서(CCD, CMOS 등) 등과의 거리
- 디지털 카메라 등에서는 mm 단위로 표현디지만 **카메라 모델에서 말하는 초점거리 f는 pixel 단위로 표현**된다.
- pixel은 이미지 센서의 cell에 대응딘다. 그러므로 초점거리(f)가 pixel 단위라는 것은 **초점거리가 이미지 센서의 cell의 크기에 대한 상대적인 값으로 표현된다는 것을 의미**한다.
  - cell size가 0.1mm, focal length가 500 pixel이라하면 이 카메라의 렌즈 중심에서 이미지 센서까지 거리는 이미지 센서 cell 크기의 500배, 즉 50mm라는 의미다.
  - mm가아니라 computer vision에서 pixel로 표현하는 이유는 영상에서 기하학적 해석을 용이하게 하기 위함이다.
- 카메라 초점거리를 fx, fy로 구분하는 경우가 있는데 이는 이미지 센서의 물리적 셀 간격이 가로방향과 세로방향이 서로 다를 수 이음을 모델링하기 위함이다.
  - 실제로 카메라 캘리브레이션 수행 시 fx, fy를 구분하여 반환한다.
  - fx : 초점거리가 가로 방향 셀 크기(간격)의 몇배인지를 나타낸다.
  - fy : 초점 거리가 세로 방향 센서 셀 크기(간격)의 몇배인지를 나타낸다.
  - 일반적 카메라는 셀 간격이 가로, 세로가 별차이가 없어 f=fx=fy로 하는 것이다.
- 참고로 동일 카메라로 캘리브레이션 수행 시 **이미지 해상도를 1/2로 낮추면 캘리브리에션 결과의 초점거리도 1/2로 작아진다.**
  - 실제 물리적 초점거리가 변하는 것은 아니지만 카메라 모델에서 초점거리는 상대적 개념이므로 해상도를 바꾸면 한 픽셀에 대응하는 물리 크기가 변하는 것이다. 그래서 초점거리 결과도 바뀌는 것이다.
  - 예시로 해상도를 1/2로 낮추면 이미지 센서의 2x2 셀들이 합쳐져서 하나의 픽셀이 되므로 한 픽셀에 대응하는 물리 크기가 2배가 된다. 따라서 초점 거리는 1/2이 되어야한다.

![image](https://user-images.githubusercontent.com/69780812/146341975-1f03d408-813b-44b6-a64d-68988ee53f5e.png)
- 카메라 모델의 렌즈 중심(초점) : 핀홀 카메라 모델에서 **핀홀에 해당**한다.
  - 핀홀 카메라는 모든 빛은 한 점(초점)을 직선으로 통과하여 이미지 평면에 투영된다는 모델이다.
  - 이러한 핀홀 모델은 3D공간과  2D 이미지 평변 사이의 기하학적 투영 관계를 매우 단순화 시켜준다.

![image](https://user-images.githubusercontent.com/69780812/146341933-853def1c-d2d0-4452-b5a5-170e954d0518.png)
- **초점**으로부터 **거리가 1(unit distance) 평면** : **normalized image plane**
  - **이 평면상의 좌표**를 보통 **normalized image coordinate**이라고 부른다.
    - 실제로 존재하지 않는 가상의 이미지 평면이다.
- 카메라 좌표계 상의 한점 (Xc, Yc, Zc)를 영상좌표계로 변환할 때 Xc,Yc를 Zc(카메라 초점에서의 거리)로 나누는 것은 이 normalized image plane 상 좌표로 변환하는 것이다.
  - 여기에 다시 초점 거리(f)를 곱하면 원하는 이미지 평면에서의 영상 좌표(pixel)가 나온다.
- 이미지에서 픽셀좌표는 이미지 중심이 아닌 이미지 좌상단 모서리를 기준(원점)으로하기 때문에 실제 최종적인 영상 좌표는 여기에 cx, cy를 더한 값이 된다.
  - x = fx*(X/Z) + cx
  - y = fy*(Y/Z) + cy
- 참고로 **이미지 평면**은 **실제로는 렌즈 뒤쪽**에 있지만 **기하학적 연산을 단순화하기 위해 렌즈 앞쪽에 위치**시키는 것이 일반적이다.
  - reflected model

## 2. Principal point
- 주점 cx, cy는 카메라 렌즈의 중심 즉, 핀홀에서 이미지 센서에 내린 수선의 발의 영상 좌표로 일반적으로 말하는 영상의 중심정과는 다른 의미다.
  - 카메라 조립과정 중 오차로 인해 렌즈아 이미지 센서 수평이 어긋나면 주점과 영상 중심은 다른 값을 가진다.
- 영상 기하학에서는 단순한 이미지 센터보다는 principal point가 훨씬 중요하다.
  - 모든 기하학적 해석은 이 주점을 이용해 이뤄진다.

## 3. skew coefficient (비대칭 계수)
![image](https://user-images.githubusercontent.com/69780812/146493694-a02b1458-b1c4-4aab-96d8-bfb05a0b0b6e.png)
- 비대칭 계수는 **이미지 센서의 cell_array의 y축이 기울어진 정도**를 나타낸다.
  - tan(alpha)
- 요즘은 이러한 skew가 거의 없어 비대칭 계수까지는 고려하지 않는다고 한다.
  - skew_c = 0

# Extrinsic parameters
- 카메라 좌표계와 월드 좌표계 사이의 변환관계를 설명하는 파라미터
- 두 좌표계 사이 rotation, translation 변환으로 표현딘다.
- 카메라 외부 파라미터는 카메라 고유의 파라미터가 아니므로 어떤 위치에 어떤 방향으로 설치했는지에 따라 달라지고 월드 좌표계를 어떻게 정의했느냐에 따라 달라진다.
- 외부 파라미터를 구하기 위해서는 먼저 캘리브레이션 툴을 통해 카메라 고유의 내부 파라미터들을 구한다.

![image](https://user-images.githubusercontent.com/69780812/146494020-98f8dd22-6966-4fdf-831b-8cf1909f7011.png)
- 그리고 미리 알고있는, 샘플로 뽑은 3D 월드 좌표 - 2D 영상좌표 매칭 쌍들을 이용해 위식을 통해 변환행렬 구하면 된다.
- OpenCV의 solvePnP() 함수를 이용하면 이러한 계산을 손쉽게할 수 있다.

# Pinhole Camera model
![image](https://user-images.githubusercontent.com/69780812/146633462-ef0bb518-dadd-43d8-b359-5b0587fd361f.png)
- 하나의 바늘구멍(pinhole)을 통해 외부의 상이 이미지로 투영된다는 모델이다.
- pinhole은 렌즈의 중심에 해당되며 이 곳에서 뒷면의 상이 맺히는 곳까지 거리가 카메라 초점 거리다.
  - 광학적으로 렌즈의 중심을 투과하는 빛은 굴절되지 않고 그대로 직선으로 투과한다.
- 영상처리 분야에서 영상에 대한 모든 기하학적 해석은 이 핀홀 카메라 모델을 바탕으로 이뤄진다.
  - 사실 실제로는 렌즈계의 특성에 따른 영상왜곡을 고려해야한다.

# 캘리브레이션과 영상 해상도 그리고 Autofocusing
- 카메라에 있는 Auto Focusing 기능을 켜면 계속 촞머거리가 바뀌므로 캘리브레이션 목적에는 적합하지 않ㄴ다.
  - 캘리브레이션 결과를 다른 계산 목적에 사용하려면 이 기능은 끄고 사용하는게 좋다.
- 카메라에는 보통 해상도를 QVGA(320x240), VGA(640x480), 960x480 등 다양하게 설정할 수 있다.
- 영상 해상도를 바꾸면 카메라 캘리브레이션 결과도 바뀐다.
  - 카메라 내부 파라미터 중 초점 거리 fx, fy, 주점 cx, cy는 픽셀단위를 사용하는데 카메라의 물리적 초점거리나 이미지 센서의 크기는 변하지 않으나 한 픽셀이 나타내는 물리적 크기가 변하기 때문이다.
  - 그러므로 영상 해상도를 VGA로 놓고 캘리브레이션 한 결과와 QVGA로 놓고 캘리브레이션 한 결과를 보면 QVGA의 경우가 내부 파라미터들이 1/2씩 줄어들게 된다.
- 랜즈 왜곡 계수 (k1, k2, p1, p2)는 normalized 좌표계에서 수행되므로 영상해상도와 관계없이 항상 동일하다.
  - 한 해상도에서만 캘리브레이션을 수행해도 다른 모든 해상도에 대한 파라미터 값을 구할 수 있게 된다.
- 렌즈 왜곡계수는 동일하며 fx,fy,cx,cy만 영상 해상도에 비례해서 조정해주면 된다.

# Tips
- 카메라 캘리브레이션은 카메라와 패턴의 거리가 최대한 가까울 수록 좋다.
  - 캘리브레이션 자체는 패턴과의 거리와 상관없지만 가까우면 영상에서 좀더 정밀하게 코너점의 위치를 찾을 수 있기 때문이다.
  - 4 ~ 20 장의 패턴 영상 개수가 무난하다.
  - 패턴 영상 획득 시 되도록 다양한 각도에서 영상을 획득하면 좋다.